var DigitalInput = require('./base/digitalSensor');

const buttonMode = {
    UP: 0,
    DOWN: 1
}

var mode = buttonMode.UP; // not pressed

var pressedDateTimeLocal; // NOTE: All local timekeeping variables were appended with "*local" in attempt to fix an undefined varaible issue

// digital button, can throw singlepress and longpress events
function DigitalButton(pin, longPressDelay) {
    DigitalInput.apply(this, Array.prototype.slice.call(arguments));
    this.longPressDelay = longPressDelay || 1100;
    this.on('change', function (res) {

      // script is in 'un-pressed' state
      if (mode === buttonMode.UP) {
        // console.log('1-1) \n\t\t mode: \t\t' + mode + '\n\t\t res: \t\t' + res + '\n\t pressedDateTimeLocal: \t' + pressedDateTimeLocal + '\n\t currentDateTimeLocal: \t' + currentDateTimeLocal + '\n\t millisecondsLocal: \t\t' + millisecondsLocal);

        // user presses the button for the first time
        if (res == 1) {
          // console.log('2-1) \n\t\t mode: \t\t' + mode + '\n\t\t res: \t\t' + res + '\n\t pressedDateTimeLocal: \t' + pressedDateTimeLocal + '\n\t currentDateTimeLocal: \t' + currentDateTimeLocal + '\n\t millisecondsLocal: \t\t' + millisecondsLocal);

          pressedDateTimeLocal = new Date();
          // console.log('2-2) \n\t\t mode: \t\t' + mode + '\n\t\t res: \t\t' + res + '\n\t pressedDateTimeLocal: \t' + pressedDateTimeLocal + '\n\t currentDateTimeLocal: \t' + currentDateTimeLocal + '\n\t millisecondsLocal: \t\t' + millisecondsLocal);

          mode = buttonMode.DOWN;
          // console.log('2-3) \n\t\t mode: \t\t' + mode + '\n\t\t res: \t\t' + res + '\n\t pressedDateTimeLocal: \t' + pressedDateTimeLocal + '\n\t currentDateTimeLocal: \t' + currentDateTimeLocal + '\n\t millisecondsLocal: \t\t' + millisecondsLocal);


        }
      }

      // script is in 'pressed' state
      else {
        // console.log('3-1) \n\t\t mode: \t\t' + mode + '\n\t\t res: \t\t' + res + '\n\t pressedDateTimeLocal: \t' + pressedDateTimeLocal + '\n\t currentDateTimeLocal: \t' + currentDateTimeLocal + '\n\t millisecondsLocal: \t\t' + millisecondsLocal);

        // user is holding the button
        if (res == 1) {
          // console.log('4-1) \n\t\t mode: \t\t' + mode + '\n\t\t res: \t\t' + res + '\n\t pressedDateTimeLocal: \t' + pressedDateTimeLocal + '\n\t currentDateTimeLocal: \t' + currentDateTimeLocal + '\n\t millisecondsLocal: \t\t' + millisecondsLocal);

          // do nothing

        }

        // user releases the button
        else if (res == 0) {
          // console.log('5-1) \n\t\t mode: \t\t' + mode + '\n\t\t res: \t\t' + res + '\n\t pressedDateTimeLocal: \t' + pressedDateTimeLocal + '\n\t currentDateTimeLocal: \t' + currentDateTimeLocal + '\n\t millisecondsLocal: \t\t' + millisecondsLocal);

          // record time button is released
          var currentDateTimeLocal = new Date();
          // console.log('5-2) \n\t\t mode: \t\t' + mode + '\n\t\t res: \t\t' + res + '\n\t pressedDateTimeLocal: \t' + pressedDateTimeLocal + '\n\t currentDateTimeLocal: \t' + currentDateTimeLocal + '\n\t millisecondsLocal: \t\t' + millisecondsLocal);

          // compute how much time passed between press and release
          var millisecondsLocal = (currentDateTimeLocal.getTime() - pressedDateTimeLocal.getTime());
          // console.log('5-3) \n\t\t mode: \t\t' + mode + '\n\t\t res: \t\t' + res + '\n\t pressedDateTimeLocal: \t' + pressedDateTimeLocal + '\n\t currentDateTimeLocal: \t' + currentDateTimeLocal + '\n\t millisecondsLocal: \t\t' + millisecondsLocal);

          // if button was held down for less than longPressDelay, in milliseconds
          if (millisecondsLocal <= this.longPressDelay) {
            this.emit('down', 'singlepress');
            console.log('6-1) singlepress');

          } else {
            this.emit('down', 'longpress');
            console.log('7-1) longpress');

          }
          // script resets to 'un-pressed' state
          mode = buttonMode.UP;
        }

      }


//        This is old code, which may or may not work

//
// //	var currentDateTimeLocal;
// //	var millisecondsLocal;
//         //user presses the button for the first time
//         if (res == 1 && mode === buttonMode.UP) {
//             var pressedDateTimeLocal = new Date();
//             mode = buttonMode.DOWN;
//             //return;
//             break;
//         }
//
// /*
// 	else if (pressedDateTimeLocal == null) {
// 	    pressedDateTimeLocal = new Date();
// 	    mode = buttonMode.DOWN;
// 	    return;
// 	}
// */
//
//         //user continues to press the button
//         else if (res == 1 && mode === buttonMode.DOWN) {
//             //do nothing
//             //return;
//             break;
//         }
//
//         //res == 0 so user has lifted her finger
//         else if (res == 0 && mode === buttonMode.DOWN) {
//             var currentDateTimeLocal = new Date();
//             var millisecondsLocal = (currentDateTimeLocal.getTime() - pressedDateTimeLocal.getTime());
//             //if less than longPressDelay millisecondsLocal
//             if (millisecondsLocal <= this.longPressDelay) {
//                 this.emit('down', 'singlepress');
//             } else {
//                 this.emit('down', 'longpress');
//             }
//             //reset the mode
//             mode = buttonMode.UP;
//             //return;
//             break;
//         }
    });
}

DigitalButton.prototype = new DigitalInput();

module.exports = DigitalButton;
