var DigitalInput = require('./base/digitalSensor');

const buttonMode = {
    UP: 0,
    DOWN: 1
}

var mode = buttonMode.UP; // not pressed

var pressedDateTimeLocal;

// digital button, can throw singlepress and longpress events
function DigitalButton(pin, longPressDelay) {
    DigitalInput.apply(this, Array.prototype.slice.call(arguments));
    this.longPressDelay = longPressDelay || 1100;
    this.on('change', function (res) {

      // script is in 'un-pressed' state
      if (mode === buttonMode.UP) {
        console.log('1-1) \n\t\t mode: \t\t' + mode + '\n\t\t res: \t\t' + res + '\n\t pressedDateTimeLocal: \t' + pressedDateTimeLocal + '\n\t currentDateTime: \t' + currentDateTime + '\n\t milliseconds: \t\t' + milliseconds);

        // user presses the button for the first time
        if (res == 1) {

          console.log('2-1) \n\t\t mode: \t\t' + mode + '\n\t\t res: \t\t' + res + '\n\t pressedDateTimeLocal: \t' + pressedDateTimeLocal + '\n\t currentDateTime: \t' + currentDateTime + '\n\t milliseconds: \t\t' + milliseconds);

         pressedDateTimeLocal = new Date();
         console.log('2-2) \n\t\t mode: \t\t' + mode + '\n\t\t res: \t\t' + res + '\n\t pressedDateTimeLocal: \t' + pressedDateTimeLocal + '\n\t currentDateTime: \t' + currentDateTime + '\n\t milliseconds: \t\t' + milliseconds);

          mode = buttonMode.DOWN;

          console.log('2-3) \n\t\t mode: \t\t' + mode + '\n\t\t res: \t\t' + res + '\n\t pressedDateTimeLocal: \t' + pressedDateTimeLocal + '\n\t currentDateTime: \t' + currentDateTime + '\n\t milliseconds: \t\t' + milliseconds);


        }
      }

      // script is in 'pressed' state
      else {
        // console.log('3) mode: ' + mode);
        console.log('3-1) \n\t\t mode: \t\t' + mode + '\n\t\t res: \t\t' + res + '\n\t pressedDateTimeLocal: \t' + pressedDateTimeLocal + '\n\t currentDateTime: \t' + currentDateTime + '\n\t milliseconds: \t\t' + milliseconds);

        // user is holding the button
        console.log('5-1) \n\t\t mode: \t\t' + mode + '\n\t\t res: \t\t' + res + '\n\t pressedDateTimeLocal: \t' + pressedDateTimeLocal + '\n\t currentDateTime: \t' + currentDateTime + '\n\t milliseconds: \t\t' + milliseconds);
        if (res == 1) {
          // do nothing

          console.log('6-1) \n\t\t mode: \t\t' + mode + '\n\t\t res: \t\t' + res + '\n\t pressedDateTimeLocal: \t' + pressedDateTimeLocal + '\n\t currentDateTime: \t' + currentDateTime + '\n\t milliseconds: \t\t' + milliseconds);


        }

        // user releases the button
        else if (res == 0) {

          console.log('7-1) \n\t\t mode: \t\t' + mode + '\n\t\t res: \t\t' + res + '\n\t pressedDateTimeLocal: \t' + pressedDateTimeLocal + '\n\t currentDateTime: \t' + currentDateTime + '\n\t milliseconds: \t\t' + milliseconds);


          var currentDateTime = new Date();

          console.log('7-2) \n\t\t mode: \t\t' + mode + '\n\t\t res: \t\t' + res + '\n\t pressedDateTimeLocal: \t' + pressedDateTimeLocal + '\n\t currentDateTime: \t' + currentDateTime + '\n\t milliseconds: \t\t' + milliseconds);


          var milliseconds = (currentDateTime.getTime() - pressedDateTimeLocal.getTime());

          console.log('7-3) \n\t\t mode: \t\t' + mode + '\n\t\t res: \t\t' + res + '\n\t pressedDateTimeLocal: \t' + pressedDateTimeLocal + '\n\t currentDateTime: \t' + currentDateTime + '\n\t milliseconds: \t\t' + milliseconds);


          // if button was held down for less than longPressDelay, in milliseconds
          if (milliseconds <= this.longPressDelay) {
            this.emit('down', 'singlepress');
            console.log('8-1) singlepress');

          } else {
            this.emit('down', 'longpress');
            console.log('9-1) longpress');

          }
          // script resets to 'un-pressed' state
          mode = buttonMode.UP;
        }

      }


//
// //	var currentDateTime;
// //	var milliseconds;
//         //user presses the button for the first time
//         if (res == 1 && mode === buttonMode.UP) {
//             var pressedDateTimeLocal = new Date();
//             mode = buttonMode.DOWN;
//             //return;
//             break;
//         }
//
// /*
// 	else if (pressedDateTimeLocal == null) {
// 	    pressedDateTimeLocal = new Date();
// 	    mode = buttonMode.DOWN;
// 	    return;
// 	}
// */
//
//         //user continues to press the button
//         else if (res == 1 && mode === buttonMode.DOWN) {
//             //do nothing
//             //return;
//             break;
//         }
//
//         //res == 0 so user has lifted her finger
//         else if (res == 0 && mode === buttonMode.DOWN) {
//             var currentDateTime = new Date();
//             var milliseconds = (currentDateTime.getTime() - pressedDateTimeLocal.getTime());
//             //if less than longPressDelay milliseconds
//             if (milliseconds <= this.longPressDelay) {
//                 this.emit('down', 'singlepress');
//             } else {
//                 this.emit('down', 'longpress');
//             }
//             //reset the mode
//             mode = buttonMode.UP;
//             //return;
//             break;
//         }
    });
}

DigitalButton.prototype = new DigitalInput();

module.exports = DigitalButton;
